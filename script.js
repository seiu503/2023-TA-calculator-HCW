const lookup = [
  {
    "userHours": 1,
    "eocHourly": 20.77,
    "locTotal": 2030,
    "increaseOverCurrent": 426,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 2,
    "eocHourly": 20.77,
    "locTotal": 4060,
    "increaseOverCurrent": 853,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 3,
    "eocHourly": 20.77,
    "locTotal": 6090,
    "increaseOverCurrent": 1279,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 4,
    "eocHourly": 20.77,
    "locTotal": 8120,
    "increaseOverCurrent": 1706,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 5,
    "eocHourly": 20.77,
    "locTotal": 10150,
    "increaseOverCurrent": 2132,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 6,
    "eocHourly": 20.77,
    "locTotal": 12180,
    "increaseOverCurrent": 2559,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 7,
    "eocHourly": 20.77,
    "locTotal": 14211,
    "increaseOverCurrent": 2985,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 8,
    "eocHourly": 20.77,
    "locTotal": 16241,
    "increaseOverCurrent": 3412,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 9,
    "eocHourly": 20.77,
    "locTotal": 18271,
    "increaseOverCurrent": 3838,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 10,
    "eocHourly": 20.77,
    "locTotal": 20301,
    "increaseOverCurrent": 4265,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 11,
    "eocHourly": 20.77,
    "locTotal": 22331,
    "increaseOverCurrent": 4691,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 12,
    "eocHourly": 20.77,
    "locTotal": 24361,
    "increaseOverCurrent": 5118,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 13,
    "eocHourly": 20.77,
    "locTotal": 26391,
    "increaseOverCurrent": 5544,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 14,
    "eocHourly": 20.77,
    "locTotal": 28421,
    "increaseOverCurrent": 5971,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 15,
    "eocHourly": 20.77,
    "locTotal": 30451,
    "increaseOverCurrent": 6397,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 16,
    "eocHourly": 20.77,
    "locTotal": 32481,
    "increaseOverCurrent": 6824,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 17,
    "eocHourly": 20.77,
    "locTotal": 34511,
    "increaseOverCurrent": 7250,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 18,
    "eocHourly": 20.77,
    "locTotal": 36541,
    "increaseOverCurrent": 7677,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 19,
    "eocHourly": 20.77,
    "locTotal": 38572,
    "increaseOverCurrent": 8103,
    "numCOLAs": 2,
    "numSteps": 0
  },
  {
    "userHours": 20,
    "eocHourly": 21.77,
    "locTotal": 41642,
    "increaseOverCurrent": 8530,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 21,
    "eocHourly": 21.77,
    "locTotal": 43724,
    "increaseOverCurrent": 8956,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 22,
    "eocHourly": 21.77,
    "locTotal": 45806,
    "increaseOverCurrent": 9383,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 23,
    "eocHourly": 21.77,
    "locTotal": 47888,
    "increaseOverCurrent": 9809,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 24,
    "eocHourly": 21.77,
    "locTotal": 49970,
    "increaseOverCurrent": 10236,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 25,
    "eocHourly": 21.77,
    "locTotal": 52052,
    "increaseOverCurrent": 10662,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 26,
    "eocHourly": 21.77,
    "locTotal": 54134,
    "increaseOverCurrent": 11088,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 27,
    "eocHourly": 21.77,
    "locTotal": 56216,
    "increaseOverCurrent": 11515,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 28,
    "eocHourly": 21.77,
    "locTotal": 58298,
    "increaseOverCurrent": 11941,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 29,
    "eocHourly": 21.77,
    "locTotal": 60380,
    "increaseOverCurrent": 12368,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 30,
    "eocHourly": 21.77,
    "locTotal": 62462,
    "increaseOverCurrent": 12794,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 31,
    "eocHourly": 21.77,
    "locTotal": 64544,
    "increaseOverCurrent": 13221,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 32,
    "eocHourly": 21.77,
    "locTotal": 66627,
    "increaseOverCurrent": 13647,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 33,
    "eocHourly": 21.77,
    "locTotal": 68709,
    "increaseOverCurrent": 14074,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 34,
    "eocHourly": 21.77,
    "locTotal": 70791,
    "increaseOverCurrent": 14500,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 35,
    "eocHourly": 21.77,
    "locTotal": 72873,
    "increaseOverCurrent": 14927,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 36,
    "eocHourly": 21.77,
    "locTotal": 74955,
    "increaseOverCurrent": 15353,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 37,
    "eocHourly": 21.77,
    "locTotal": 77037,
    "increaseOverCurrent": 15780,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 38,
    "eocHourly": 21.77,
    "locTotal": 79119,
    "increaseOverCurrent": 16206,
    "numCOLAs": 2,
    "numSteps": 1
  },
  {
    "userHours": 39,
    "eocHourly": 22.77,
    "locTotal": 83229,
    "increaseOverCurrent": 16633,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 40,
    "eocHourly": 22.77,
    "locTotal": 85363,
    "increaseOverCurrent": 17059,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 41,
    "eocHourly": 22.77,
    "locTotal": 87497,
    "increaseOverCurrent": 17486,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 42,
    "eocHourly": 22.77,
    "locTotal": 89631,
    "increaseOverCurrent": 17912,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 43,
    "eocHourly": 22.77,
    "locTotal": 91765,
    "increaseOverCurrent": 18339,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 44,
    "eocHourly": 22.77,
    "locTotal": 93900,
    "increaseOverCurrent": 18765,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 45,
    "eocHourly": 22.77,
    "locTotal": 96034,
    "increaseOverCurrent": 19192,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 46,
    "eocHourly": 22.77,
    "locTotal": 98168,
    "increaseOverCurrent": 19618,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 47,
    "eocHourly": 22.77,
    "locTotal": 100302,
    "increaseOverCurrent": 20045,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 48,
    "eocHourly": 22.77,
    "locTotal": 102436,
    "increaseOverCurrent": 20471,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 49,
    "eocHourly": 22.77,
    "locTotal": 104570,
    "increaseOverCurrent": 20898,
    "numCOLAs": 2,
    "numSteps": 2
  },
  {
    "userHours": 50,
    "eocHourly": 22.77,
    "locTotal": 106704,
    "increaseOverCurrent": 21324,
    "numCOLAs": 2,
    "numSteps": 2
  }
];

// set global variables
let userHours = 0;
let numberOfCOLAs = 0;
let numberOfSteps = 0;
let endHourlyRate = 0;
let payIncreaseDollar = 0;
let payIncreasePercent = 0;
let lifeOfContractTotal = 0;
let userLang = "en-US";
let userLangCode = "en";
let userObj = {};

// translation object
const trans = {
  p1_1: {
    en: "You will be eligible for ",
    es: "Usted será elegible para ",
    ru: "Вы будете иметь право на ",
    vi: "Bạn sẽ đủ điều kiện nhận ",
    zh: "合同结束时，您将有资格获得 "
  },
  p1_2: {
    en: " COLAs (Cost of Living Adjustments) and up to ",
    es: " ajustes por costo de vida (COLA, siglas en inglés) a su salario y hasta ",
    ru: " COLA (корректировки стоимости жизни) и до ",
    vi: " COLA (Điều chỉnh chi phí sinh hoạt) và tăng lên tới ", 
    zh: " COLA（生活费用调整）和直到 "
  },
  p1_3: {
    en: " step increases by the end of the contract.",
    es: " aumentos por escalafón al vencimiento del contrato colectivo.",
    ru: " поступенчатых повышений зарплаты к концу действия контракта. ",
    vi: " bậc khi kết thúc hợp đồng.", 
    zh: " 步加薪。"
  },
  p2_1: {
    en: "Your hourly rate by the end of the 2023-2025 contract will be ",
    es: "Su pago por hora al final del contrato 2023-2025 será ",
    ru: "Ваша почасовая ставка к концу контракта на 2023-2025 годы составит ",
    vi: "Mức lương theo giờ của bạn vào cuối hợp đồng 2023-2025 sẽ là ", 
    zh: "到 2023-2025 年合同结束时，您的时薪将为 "
  },
  p3_1: {
    en: "This pay increase is ",
    es: "Este aumento salarial es ",
    ru: "Это увеличение заработной платы на ",
    vi: "Mức tăng lương này là ",
    zh: "此次加薪比当前 17.77 美元的基本工资高 "
  },
  p3_2: {
    en: " more per hour than the current base rate of $17.77. This is a ",
    es: " más por hora que la tarifa base actual de $17.77. Este es un aumento del ",
    ru: " больше в час, чем текущая базовая ставка в размере 17,77 долл. Это ",
    vi: " nhiều hơn mỗi giờ so với mức lương cơ bản hiện tại là 17,77 USD. Đây là mức tăng ",
    zh: " 倍。到合同结束时，每小时增加 "
  },
  p3_3: {
    en: " percent increase per hour by the end of the contract.",
    es: " por ciento por hora al vencimiento del contrato colectivo.",
    ru: "-процентное увеличение в час к концу действия контракта.",
    vi: " phần trăm mỗi giờ vào cuối hợp đồng.",
    zh: "%。"
  },
  p4_1: {
    en: "Your increase in earnings over the life of the contract is estimated to be ",
    es: "Su aumento estimado en los ingresos durante el plazo del acuerdo de negociación colectiva: ",
    ru: "Ваше увеличение заработка в течение срока действия контракта оценивается в ",
    vi: "Mức tăng thu nhập của bạn trong suốt thời hạn hợp đồng được ước tính là ",
    zh: "在合同期内，您的收入预计将增加 "
  },
  val1: {
    en: "Please select the average number of hours you work per week",
    es: "Por favor seleccione el número promedio de horas que trabaja por semana",
    ru: "Пожалуйста, выберите среднее количество часов, которые вы работаете в неделю", 
    vi: "Vui lòng chọn số giờ trung bình bạn làm việc mỗi tuần",
    zh: "请选择您每周的平均工作时间"
  }
}

document.addEventListener("DOMContentLoaded", function(){
  console.log('dom loaded');

  // save elements to variables for later access
  let displayEl = document.getElementById("display");
  let dispwrap = document.getElementById("dispwrap");
  let submit = document.getElementById("submitButton");
  let startOver = document.getElementById("startOverButton");
  let results = document.getElementById("results");
  let message = document.getElementById('message');
  let hpwEl = document.getElementById("hPW");
  let hpwCustom = document.getElementById("hPWCustom");
  let instructions = document.getElementById("instructions");
  let inputs = document.getElementById("inputs");
  let languagePicker = document.getElementsByClassName('gt_selector')[0];

  // set language code
  const setLanguageCode = () => {
    if (languagePicker) {
      console.log(`languagePicker: ${languagePicker.value}`);
      userLang = languagePicker.value;
      userLangCode = userLang.substring(3).toLowerCase();
      console.log(`userLang LP: ${userLang}`);
      console.log(`userLangCode LP: ${userLangCode}`);
    } else {
      userLang = navigator.language || navigator.userLanguage; 
      userLangCode = userLang.substring(0,2).toLowerCase();
      console.log(`userLang NOLP: ${userLang}`);
      console.log(`userLangCode NOLP: ${userLangCode}`);
    }

    const langCodeOptions = ['en', 'es', 'ru', 'vi', 'zh'];

    // default to english if user language is not supported
    if (!langCodeOptions.includes(userLangCode)) {
      console.log('userLangCode not in array');
      userLangCode = "en";
      console.log(`userLangCode: ${userLangCode}`);
    };
  }
  setLanguageCode();
  

  // generate list of hours options
  let hoursOptions = Array.from(Array(61).keys());
  hoursOptions.shift();
  console.log(hoursOptions);

  // load list of hoursOptions
  hpwEl.options.length = 1;
  hoursOptions.forEach(item => {
    hpwEl.options[hpwEl.options.length] = new Option(item, item)
  });  

  // find userObj
  const findUserObj = () => {
    console.log('findUserObj');
    console.log(`userHours: ${userHours}`);
    userObj = lookup.find((item) => item['userHours'].toString() === userHours );
    if (!userObj) { userObj = {} };
    console.log('userObj');
    console.log(userObj);
  };

  // listen for changes to hours worked
  function hoursChange(e) {
    console.log('hoursChange');
    userHours = e.target.value;
    console.log(`userHours: ${userHours}`);
    findUserObj();
  }

  // clean currency strings
  const clean = (str) => {
    if (typeof(str) == "number") {
      return str;
    } else {
      return parseFloat(str.replace(/[^0-9]/g, ""));
    }
  };




  // generate results string and message
  function resultsString() {
    // set variables
    let numCOLAs = userObj['numCOLAs'] || 0;
    let numSteps = userObj['numSteps'] || 0;
    let eocHourly = userObj['eocHourly'] || 0;
    let payIncreaseDollar = eocHourly - 17.77 || 0;
    let payIncreasePercent = (payIncreaseDollar / 17.77 * 100).toFixed(0) || 0;
    let locTotal = userObj['locTotal'] || 0;

    console.log(`numCOLAs: ${numCOLAs}`);
    console.log(`numSteps: ${numSteps}`);
    console.log(`eocHourly: ${eocHourly}`);
    console.log(`payIncreaseDollar: ${payIncreaseDollar}`);
    console.log(`payIncreasePercent: ${payIncreasePercent}`);
    console.log(`locTotal: ${locTotal}`);

    if (!userObj['numCOLAs']) {
      return `<p>No data available yet for that number of hours per week</p>`
    }

    return `<p style="max-width: 600px; margin: auto auto 20px auto;"><ul style="max-width: 600px; margin: auto;"><li style="margin-bottom:15px;">${trans['p1_1'][userLangCode]}<span class="purplebold">${numCOLAs}</span>${trans['p1_2'][userLangCode]}<span class="purplebold">${numCOLAs}</span>${trans['p1_3'][userLangCode]}</li>
    <li style="margin-bottom:15px;">${trans['p2_1'][userLangCode]}<span class="purplebold">$${eocHourly}</span>.</li>
    <li style="margin-bottom:15px;">${trans['p3_1'][userLangCode]}<span class="purplebold">$${payIncreaseDollar.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>${trans['p3_2'][userLangCode]}<span class="purplebold">${payIncreasePercent}</span>${trans['p3_3'][userLangCode]}</li>
    <li style="margin-bottom:15px;">${trans['p4_1'][userLangCode]}<span class="purplebold">$${locTotal.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>.</li></ul>
    </p>`
  }

  // On reload, reload page
  function handleReload() {
    window.location.reload();
  }

  // On submit, hide instructions and display results
  function handleSubmit(e) {
    e.preventDefault();
    if (!userHours || userHours == 0) {
      console.log('!userHours');
      submit.setAttribute("style", "display:none;");
      startOver.setAttribute("style", "display:block;");
      instructions.setAttribute("style", "height: 0; display:none;");
      inputs.setAttribute("style", "height: 0; display:none;");
      message.setAttribute("style", "display:block;");
      results.innerHTML = `<h3 class=center>${trans['val1'][userLangCode]}</h3>`;
      return;
    }
    submit.setAttribute("style", "display:none;");
    startOver.setAttribute("style", "display:block;");
    instructions.setAttribute("style", "height: 0; display:none;");
    inputs.setAttribute("style", "height: 0; display:none;");
    message.setAttribute("style", "display:block;");
    results.innerHTML = resultsString();
  }

  submit.addEventListener("click", handleSubmit);
  startOver.addEventListener("click", handleReload);
  if(languagePicker) {
    languagePicker.addEventListener("change", setLanguageCode);
  }
  

  // custom select styling

  let x, i, j, l, ll, selElmnt, a, b, c;
  /* Look for any elements with the class "custom-select": */
  x = document.getElementsByClassName("custom-select");
  l = x.length;

  function replaceSelect(selElmnt, customElmt, replace) {
    ll = selElmnt.length;

    if (replace) {
      /* For each element, create a new DIV that will act as the selected item: */
      a = document.createElement("DIV");
      a.setAttribute("class", `select-selected ${selElmnt.getAttribute('id')}`);
    } else {
      a = document.getElementsByClassName(`select-selected ${selElmnt.getAttribute('id')}`)[0];
    }
    a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
    customElmt.appendChild(a);
    /* For each element, create a new DIV that will contain the option list: */
    b = document.createElement("DIV");
    b.setAttribute("class", "select-items select-hide");
    
    for (j = 1; j < ll; j++) {

      /* For each option in the original select element,
      create a new DIV that will act as an option item: */
      c = document.createElement("DIV");
      c.innerHTML = selElmnt.options[j].innerHTML;
      c.addEventListener("click", function(e) {
          /* When an item is clicked, update the original select box,
          and the selected item: */
          let y, i, k, s, h, sl, yl;
          s = this.parentNode.parentNode.getElementsByTagName("select")[0];
          sl = s.length;
          h = this.parentNode.previousSibling;
          for (i = 0; i < sl; i++) {
            if (s.options[i].innerHTML == this.innerHTML) {
              s.selectedIndex = i;
              h.innerHTML = this.innerHTML;
              y = this.parentNode.getElementsByClassName("same-as-selected");
              yl = y.length;
              for (k = 0; k < yl; k++) {
                y[k].removeAttribute("class");
              }
              this.setAttribute("class", "same-as-selected");
              break;
            }
          }
          if (s.getAttribute('id') === 'hPW') {
            hoursChange({ target: s });
          };
          h.click();
      });
      b.appendChild(c);
    }
    customElmt.appendChild(b);
    a.addEventListener("click", function(e) {
      /* When the select box is clicked, close any other select boxes,
      and open/close the current select box: */
      e.stopPropagation();
      closeAllSelect(this);
      this.nextSibling.classList.toggle("select-hide");
      this.classList.toggle("select-arrow-active");
    });
  }
  for (i = 0; i < l; i++) {
    let customElmt = x[i];
    selElmnt = customElmt.getElementsByTagName("select")[0];
    replaceSelect(selElmnt, customElmt, true);
  }

  function closeAllSelect(elmnt) {
    /* A function that will close all select boxes in the document,
    except the current select box: */
    let x, y, i, xl, yl, arrNo = [];
    x = document.getElementsByClassName("select-items");
    y = document.getElementsByClassName("select-selected");
    xl = x.length;
    yl = y.length;
    for (i = 0; i < yl; i++) {
      if (elmnt == y[i]) {
        arrNo.push(i)
      } else {
        y[i].classList.remove("select-arrow-active");
      }
    }
    for (i = 0; i < xl; i++) {
      if (arrNo.indexOf(i)) {
        x[i].classList.add("select-hide");
      }
    }
  }

  /* If the user clicks anywhere outside the select box,
  then close all select boxes: */
  document.addEventListener("click", closeAllSelect); 

});
